<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Study Master: Brick Breaker Elite</title>
    <style>
        body { 
            background: #89b4fa; text-align: center; 
            font-family: 'Arial Black', sans-serif; margin: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow: hidden;
        }
        h1 { margin: 15px 0 5px 0; color: #212121; text-shadow: 2px 2px white; }
        
        .stats-bar { 
            display: flex; justify-content: space-around; width: 600px; 
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 10px;
            color: white; border: 2px solid rgba(255,255,255,0.3);
        }

        .back-btn { 
            background: #c0c0c0; border: 4px solid #fff; 
            border-bottom: 4px solid #606060; border-right: 4px solid #606060;
            padding: 12px; width: 320px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-bottom: 15px; font-family: inherit;
        }

        #game-container { position: relative; }
        canvas { 
            background: #111; border: 5px solid #fff; border-radius: 10px;
            display: block; cursor: none; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        }

        #ui-overlay {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: white;
            padding: 40px; border: 6px solid #212121; border-radius: 20px;
            text-align: center; width: 300px; z-index: 10;
        }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 80px; color: white; text-shadow: 4px 4px #000; pointer-events: none;
            display: none; z-index: 5; width: 100%;
        }

        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .legend {
            margin-top: 20px; background: white; padding: 12px;
            border-radius: 15px; border: 4px solid #212121; display: flex; gap: 12px;
            flex-wrap: wrap; justify-content: center; width: 680px;
        }
        .item { display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .box { width: 14px; height: 14px; border-radius: 2px; }
        
        .btn {
            background: #212121; color: white; border: none;
            padding: 12px 25px; cursor: pointer; font-family: 'Arial Black';
            margin-top: 15px; border-radius: 8px; font-size: 18px;
        }
    </style>
</head>
<body>

    <h1>BRICK BREAKER ELITE</h1>

    <div class="stats-bar">
        <div>SCORE: <span id="score">0</span></div>
        <div>LEVEL: <span id="level">1</span></div>
        <div style="color:#ff4d4d">LIVES: <span id="lives">❤️❤️❤️</span></div>
    </div>

    <button class="back-btn" onclick="window.location.href='../index.html'">
        RETURN TO HUB
    </button>

    <div id="game-container">
        <canvas id="brickCanvas"></canvas>
        <div id="countdown"></div>
        <div id="ui-overlay">
            <h2 id="statusTitle">LEVEL CLEAR!</h2>
            <button class="btn" id="actionBtn">CONTINUE</button>
        </div>
    </div>

    <div class="legend">
        <div class="item"><div class="box" style="background:#00f"></div> BLUE: WIDE</div>
        <div class="item"><div class="box" style="background:#f00"></div> RED: LIFE</div>
        <div class="item"><div class="box" style="background:#0f0"></div> GREEN: MULTI</div>
        <div class="item"><div style="width:10px;height:10px;border-radius:50%;background:#fff;border:1px solid #000"></div> WHITE: MAIN</div>
        <div class="item"><div style="width:10px;height:10px;border-radius:50%;background:#ffd700;border:1px solid #000"></div> GOLD: SAFE</div>
    </div>

    <script>
        const canvas = document.getElementById('brickCanvas');
        const ctx = canvas.getContext('2d');
        const display = document.getElementById('countdown');
        canvas.width = 600; canvas.height = 400;

        let score = 0, lives = 3, level = 1, gameRunning = false;
        let balls = [];
        let paddle = { w: 90, h: 12, x: 255 };
        let bricks = [], powerUps = [];
        let rightPressed = false, leftPressed = false;

        function createLevel(lvl) {
            bricks = [];
            let rows = 4 + lvl;
            let cols = 8;
            for(let c=0; c<cols; c++) {
                bricks[c] = [];
                for(let r=0; r<rows; r++) {
                    let active = true;
                    if(lvl === 2 && (c === 3 || c === 4)) active = false;
                    if(lvl === 3 && (r + c < 4 || r + c > 10)) active = false;
                    bricks[c][r] = { 
                        x: c * 72 + 15, 
                        y: r * 25 + 50, 
                        status: active ? 1 : 0, 
                        color: `hsl(${r * 45}, 80%, 60%)` 
                    };
                }
            }
        }

        function startCountdown() {
            gameRunning = false;
            let count = 3;
            display.innerText = count;
            display.style.color = "white";
            display.style.fontSize = "80px";
            display.style.display = 'block';
            
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    display.innerText = count;
                } else if (count === 0) {
                    display.innerText = "GO!";
                } else {
                    clearInterval(timer);
                    display.style.display = 'none';
                    gameRunning = true;
                    balls = [{ x: 300, y: 350, dx: 4 + (level * 0.3), dy: -4 - (level * 0.3), r: 8, trail: [], isSafe: false }];
                    requestAnimationFrame(draw);
                }
            }, 700);
        }

        function animateLifeLoss() {
            gameRunning = false;
            canvas.classList.add('shake');
            display.innerText = "LIFE LOST";
            display.style.color = "#ff4d4d";
            display.style.fontSize = "50px";
            display.style.display = "block";

            setTimeout(() => {
                canvas.classList.remove('shake');
                startCountdown();
            }, 1200);
        }

        document.addEventListener("keydown", (e) => { if(e.key === "ArrowRight") rightPressed = true; if(e.key === "ArrowLeft") leftPressed = true; });
        document.addEventListener("keyup", (e) => { if(e.key === "ArrowRight") rightPressed = false; if(e.key === "ArrowLeft") leftPressed = false; });

        function draw() {
            if(!gameRunning) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let remaining = 0;
            bricks.forEach(col => col.forEach(b => {
                if(b.status === 1) {
                    remaining++;
                    ctx.fillStyle = b.color;
                    ctx.fillRect(b.x, b.y, 65, 20);
                    balls.forEach(ball => {
                        if(ball.x > b.x && ball.x < b.x + 65 && ball.y > b.y && ball.y < b.y + 20) {
                            ball.dy = -ball.dy; b.status = 0; score += 20;
                            document.getElementById('score').innerText = score;
                            let rand = Math.random();
                            if(rand < 0.08) powerUps.push({x: b.x + 30, y: b.y, type: 'wide'});
                            else if(rand < 0.14) powerUps.push({x: b.x + 30, y: b.y, type: 'life'});
                            else if(rand < 0.22) powerUps.push({x: b.x + 30, y: b.y, type: 'multi'});
                        }
                    });
                }
            }));

            if(remaining === 0) { 
                // NEW LOGIC: Max lives decreases at Level 4+
                let maxLives = level >= 3 ? 2 : 3; 
                lives = maxLives;
                updateLives();
                showOverlay("LEVEL COMPLETE!", true); 
                return; 
            }

            powerUps.forEach((p, i) => {
                p.y += 3;
                ctx.fillStyle = p.type === 'wide' ? '#00f' : p.type === 'life' ? '#f00' : '#0f0';
                ctx.fillRect(p.x, p.y, 18, 18);
                if(p.y > canvas.height - 25 && p.x > paddle.x && p.x < paddle.x + paddle.w) {
                    if(p.type === 'wide') { paddle.w = 160; setTimeout(() => paddle.w = 90, 8000); }
                    else if(p.type === 'life') { 
                        let currentMax = level >= 4 ? 2 : 3;
                        if(lives < currentMax) { lives++; updateLives(); } 
                    }
                    else if(p.type === 'multi') { 
                        if(balls.length > 0) {
                            balls.push({ x: paddle.x + paddle.w/2, y: canvas.height - 30, dx: -3.5, dy: -4.5, r: 8, trail: [], isSafe: true });
                            balls.push({ x: paddle.x + paddle.w/2, y: canvas.height - 30, dx: 3.5, dy: -4.5, r: 8, trail: [], isSafe: true });
                        }
                    }
                    powerUps.splice(i, 1);
                }
            });

            ctx.fillStyle = "#00d4ff"; ctx.fillRect(paddle.x, canvas.height - 20, paddle.w, paddle.h);

            for (let i = balls.length - 1; i >= 0; i--) {
                let ball = balls[i];
                ball.trail.push({x: ball.x, y: ball.y});
                if(ball.trail.length > 5) ball.trail.shift();
                
                ball.trail.forEach((t, idx) => {
                    ctx.beginPath(); ctx.arc(t.x, t.y, ball.r * (idx/5), 0, Math.PI*2);
                    ctx.fillStyle = ball.isSafe ? `rgba(255, 215, 0, ${idx/15})` : `rgba(255,255,255,${idx/15})`;
                    ctx.fill();
                });

                ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
                ctx.fillStyle = ball.isSafe ? "#ffd700" : "#fff"; 
                ctx.fill();
                ctx.strokeStyle = "#000"; ctx.lineWidth = 1; ctx.stroke();

                if(ball.x + ball.dx > canvas.width - ball.r || ball.x + ball.dx < ball.r) ball.dx = -ball.dx;
                if(ball.y + ball.dy < ball.r) ball.dy = -ball.dy;
                else if(ball.y + ball.dy > canvas.height - 25) {
                    if(ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
                        let impact = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
                        ball.dx = impact * 5; ball.dy = -Math.abs(ball.dy);
                    } else {
                        if (!ball.isSafe) {
                            balls = [];
                            lives--; updateLives();
                            if(lives <= 0) showOverlay("GAME OVER", false);
                            else animateLifeLoss();
                            return; 
                        } else {
                            balls.splice(i, 1);
                        }
                    }
                }
                ball.x += ball.dx; ball.y += ball.dy;
            }

            if(rightPressed && paddle.x < canvas.width - paddle.w) paddle.x += 8;
            if(leftPressed && paddle.x > 0) paddle.x -= 8;

            if(gameRunning) requestAnimationFrame(draw);
        }

        function updateLives() { document.getElementById('lives').innerText = "❤️".repeat(Math.max(0, lives)); }

        function showOverlay(text, win) {
            gameRunning = false;
            document.getElementById('ui-overlay').style.display = "block";
            document.getElementById('statusTitle').innerText = text;
            document.getElementById('actionBtn').onclick = () => {
                if(win) {
                    level++;
                } else {
                    score = 0; level = 1; lives = 3;
                }
                document.getElementById('level').innerText = level;
                updateLives();
                document.getElementById('ui-overlay').style.display = "none";
                createLevel(level);
                paddle.x = 255;
                powerUps = [];
                startCountdown();
            };
        }

        createLevel(1);
        updateLives();
        startCountdown();
    </script>
</body>
</html>